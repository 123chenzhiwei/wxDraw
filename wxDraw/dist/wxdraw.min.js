"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}function Point(t,i){this.x=t,this.y=i}function Watch(){this.startTime=0,this.running=!1,this.goesBytime=0,this.goesBy=void 0,this.DEFAULT_ELASTIC=2}function fakeAnimationFrame(t){var i;setTimeout(function(){i=+new Date,t(i)},16)}function WxDraw(t,i,s,e,n){this.canvas=t,this.wcid=guid(),this.store=new Store,this.bus=new eventBus,console.log(this.bus),this.animation=new Animation(this.bus),this.x=i,this.y=s,this.w=e,this.h=n,this.bus.add("addAnimation",this,this.addAnimationFrag),console.log(this.bus),this.animation.start(),Shape.bus=this.bus}var _toConsumableArray=_interopDefault(require("babel-runtime/helpers/toConsumableArray")),guid=function(){var t=9707740;return function(){return t++}},util={mix:function(t,i,s){t="prototype"in t?t.prototype:t,i="prototype"in i?i.prototype:i,this.extend(t,i,s)},extend:function(t,i,s){for(var e in i)i.hasOwnProperty(e)&&(s?null!=i[e]:null==t[e])&&(t[e]=i[e]);return t}},Store=function(){this.store=[]};Store.prototype={add:function(t){this.store.push(t)},update:function(){},delete:function(){}};var pOption={x:10,y:10,r:10,sides:7,fillStyle:"red",strokeStyle:"red"},Polygon=function(t){var i=util.extend(t,pOption);this.x=i.x,this.y=i.y,this.x=i.x,this.radius=i.r,this.sides=i.sides,this.max={maxX:0,maxY:0,minX:0,minY:0},this.points=this.getPoints(),this.fillStyle=i.fillStyle,this.strokeStyle=i.strokeStyle,this._isChoosed=!1};Polygon.prototype={getPoints:function(){var t=[],i=this.startAngle||0;this.max={maxX:0,maxY:0,minX:0,minY:0};for(var s=0;s<this.sides;++s)t.push(new Point(this.x+this.radius*Math.sin(i),this.y-this.radius*Math.cos(i))),this.x+this.radius*Math.sin(i)>this.max.maxX&&(this.max.maxX=this.x+this.radius*Math.sin(i)),this.max.minX||(this.max.minX=this.x+this.radius*Math.sin(i)),this.max.minX&&this.x+this.radius*Math.sin(i)<this.max.minX&&(this.max.minX=this.x+this.radius*Math.sin(i)),this.y+this.radius*Math.sin(i)>this.max.maxY&&(this.max.maxY=this.y+this.radius*Math.sin(i)),this.max.minY||(this.max.minY=this.y+this.radius*Math.sin(i)),this.max.minY&&this.y+this.radius*Math.sin(i)<this.max.minY&&(this.max.minY=this.y+this.radius*Math.sin(i)),i+=2*Math.PI/this.sides;return t},createPath:function(t){var i=this.getPoints();t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var s=1;s<this.sides;++s)t.lineTo(i[s].x,i[s].y);t.closePath()},stroke:function(t){t.save(),this.createPath(t),t.setStrokeStyle(this.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),this.createPath(t),t.setStrokeStyle(this.fillStyle),t.fill(),t.restore()},move:function(t,i){this.x=t,this.y=i},detected:function(t,i){t>this.max.minX&&t<this.max.maxX&&i>this.max.minY&&i<this.max.maxY&&(this.points=this.getPoints(),this._offsetX=this.x-t,this._offsetY=this.y-i,this._pnpolyTest(t,i)&&(this._isChoosed=!0))},moveDetect:function(t,i){1==this._isChoosed&&this.move(t+this._offsetX,i+this._offsetY)},upDetect:function(){this._isChoosed=!1},_pnpolyTest:function(t,i){for(var s=!1,e=0,n=this.points.length-1;e<this.points.length;n=e++){var o=this.points[e].x,h=this.points[e].y,r=this.points[n].x,a=this.points[n].y;h>i!=a>i&&t<(r-o)*(i-h)/(a-h)+o&&(s=!s)}return console.log(s),s}};var cOption={fillStyle:"red",strokeStyle:"red",x:10,y:10,r:10,sA:0,eA:2*Math.PI,counterclockwise:!1},rOption={x:10,y:10,w:10,h:10,fillStyle:"red",strokeStyle:"red"},Circle=function(t){var i=util.extend(t,cOption);console.log("_temOption",i),this.x=i.x,this.y=i.y,this.r=i.r,this.sA=i.sA,this.eA=i.eA,this.counterclockwise=i.counterclockwise,this.fillStyle=i.fillStyle,this.strokeStyle=i.strokeStyle,this._isChoosed=!1,this._offsetX=0,this._offsetY=0};Circle.prototype={stroke:function(t){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,this.sA,this.eA,this.counterclockwise),t.closePath(),t.setStrokeStyle(this.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,this.sA,this.eA,this.counterclockwise),t.closePath(),t.setFillStyle(this.fillStyle),t.fill(),t.restore()},move:function(t,i){this.x=t,this.y=i},detected:function(t,i){var s=this;if(Math.pow(s.x-t,2)+Math.pow(s.y-i,2)<=Math.pow(s.r,2))return this._offsetX=s.x-t,this._offsetY=s.y-i,console.log("x",this._offsetX),console.log("y",this._offsetY),this._isChoosed=!0,!0},moveDetect:function(t,i){1==this._isChoosed&&this.move(t+this._offsetX,i+this._offsetY)},upDetect:function(){this._isChoosed=!1}};var Rect=function(t){var i=util.extend(t,rOption);console.log(i),this.x=i.x,this.y=i.y,this.w=i.w,this.h=i.h,this.fillStyle=i.fillStyle,this.strokeStyle=i.strokeStyle,this._isChoosed=!1,this._offsetX=0,this._offsetY=0};Rect.prototype={stroke:function(t){t.save(),t.beginPath(),t.rect(this.x,this.y,this.w,this.h),t.closePath(),t.setStrokeStyle(this.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),t.beginPath(),t.rect(this.x,this.y,this.w,this.h),t.closePath(),t.setFillStyle(this.fillStyle),t.fill(),t.restore()},move:function(t,i){this.x=t,this.y=i},detected:function(t,i){var s=this;if(s.x<t&&s.y<i&&s.y+s.h>i&&s.x+s.w>t)return this._offsetX=t-s.x,this._offsetY=i-s.y,console.log("移动方块"),this._isChoosed=!0,!0},moveDetect:function(t,i){1==this._isChoosed&&this.move(t-this._offsetX,i-this._offsetY)},upDetect:function(){this._isChoosed=!1}};var EasingFunctions={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}};Watch.prototype={start:function(){this.startTime=+new Date,this.goesBytime=void 0,this.running=!0},stop:function(){this.goesBy=+new Date-this.startTime,this.running=!1},getGoesByTime:function(){if(this.running){var t=+new Date-this.startTime;return t>1&&!isNaN(t)?t:0}return this.goesBy},isRunning:function(){return this.running},reset:function(){this.goesBy=0}};var AnimationTimer=function(t,i){void 0!==t&&(this.duration=t),void 0!==i&&(this.timeFunc=i),this.watch=new Watch};AnimationTimer.prototype={start:function(){this.watch.sart()},stop:function(){this.watch.stop()},getGoesByTime:function(){var t=this.watch.getGoesByTime(),i=t/this.duration;if(this.watch.running)return this.timeFunc?t*(EasingFunctions[timeFunc](i)/i):t},isOver:function(){return this.watch.getGoesByTime>this.duration}};var FRAGOPTION={onStart:function(){},onLooping:function(){},onEnd:function(){},duration:1e3,easing:"linear"},AnimationFrag=function(t,i,s,e){var n=util.extend(FRAGOPTION,e);this.object=t,this.target=s,this.complete=!1,this.running=!1,this.started=!1,this.duration=n.duration,this.atrribute=i,this.source=this.object[i],this.timer=new AnimationTimer(n.duration,n.easing)};AnimationFrag.prototype={updateAnimation:function(){if(this.timer.isOver())return this.complete=!0,this.running=!1,!1;this.started?this.updateAtrribute():(this.started=!0,this.running=!0,this.timer.start())},updateAtrribute:function(){this.object[this.atrribute]=this.source+this.target*this.time.getGoesByTime()/this.duration}};var Shape=function(t,i,s,e,n){this.draggable=!!e,this.highlight=!!n,this.strokeOrfill=!!s,this.type=t,this.Shape=new shapeTypes[t](i),this.AnimationTimer=new AnimationTimer,this.animtionFragList=[],this.bus=null};Shape.prototype={updateBus:function(t){this.bus=t},paint:function(t){this.strokeOrfill?this.Shape.fill(t):this.Shape.stroke(t)},detect:function(t,i){this.Shape.detected(t,i),this.Shape.detected(t,i)},moveDetect:function(t,i){this.Shape.moveDetect(t,i)},upDetect:function(){this.Shape.upDetect()},animate:function(t,i,s){if("x"==t&&0==i.indexOf("+=")){var e=i.split("=")[1],n=this.Shape.x+parseFloat(e[1]),o=new AnimationFrag(this,"x",n,s);console.log(o),this.bus.dispatch("addAnimation","no",o)}}};var shapeTypes={circle:function(t){return new Circle(t)},rect:function(t){return new Rect(t)},polygon:function(t){return new Polygon(t)}},AnimationFrame=function(){return requestAnimationFrame||fakeAnimationFrame},animationFrame=AnimationFrame(),Animation=function(t){this.running=!1,this.paused=!0,this.bus=t,console.log(this.bus),this.animationFragStore=[]};Animation.prototype={start:function(){this.running=!0,this.loopAnimation()},loopAnimation:function(){function t(){animationFrame(t),i.running&&i.updateStep()}var i=this;animationFrame(t)},updateStep:function(){this.animationFragStore.forEach(function(t){t.updateAnimation()})}};var eventBus=function(){this.eventList=[]};eventBus.prototype={add:function(t,i,s){this.eventList.length||this.eventList.push({name:t,scope:i,thingsList:[s]}),this.eventList.forEach(function(e){e.name===t?e.thingsList.push(s):this.eventList.push({name:t,scope:i,thingsList:[s]})},this)},dispatch:function(t,i){var s=arguments;if(arguments.length<2)return!1;var e=Array.prototype.slice.call(s,1);this.eventList.forEach(function(s){s.name===t&&s.thingsList.forEach(function(t){"no"!==i?t.call.apply(t,[i].concat(_toConsumableArray(e))):t.call.apply(t,[s.scope].concat(_toConsumableArray(e)))})})},destroy:function(){}},WxDraw.prototype={add:function(t){t.updateBus(this.bus),this.store.add(t)},draw:function(){this.store.store.forEach(function(t){t.paint(this.canvas)},this)},detect:function(t){var i=this.getLoc(t.touches[0].x,t.touches[0].y);this.store.store.forEach(function(t){t.detect(i.x,i.y)},this)},moveDetect:function(t){var i=this.getLoc(t.touches[0].x,t.touches[0].y);this.store.store.forEach(function(t){t.moveDetect(i.x,i.y)},this),this.draw(),this.canvas.draw()},upDetect:function(){this.store.store.forEach(function(t){t.upDetect()},this)},getLoc:function(t,i){return{x:t-this.x>0?t-this.x>this.w?this.w:t-this.x:this.x,y:i-this.y>0?i-this.y>this.h?this.h:i-this.y:this.y}},update:function(){},AnimationCenter:function(){},addAnimationFrag:function(t,i){this.animation.animationFragStore.push(i)}},module.exports={WxDraw:WxDraw,Shape:Shape,AnimationFrame:AnimationFrame()};
