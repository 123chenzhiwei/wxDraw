"use strict";function Point(t,i){this.x=t,this.y=i}function Watch(){this.startTime=0,this.running=!1,this.goesBytime=0,this.goesBy=void 0,this.DEFAULT_ELASTIC=2}function genExe(t,i,n){if(!isNaN(Number(t))){return parseFloat(n.Shape[i])-parseFloat(t)}if(0==t.indexOf("+=")){return t.split("=")[1]}if(0==t.indexOf("-=")){return-1*t.split("=")[1]}}function fakeAnimationFrame(t){var i;setTimeout(function(){i=+new Date,t(i)},16)}function WxDraw(t,i,n,o,e){this.canvas=t,this.wcid=guid(),this.store=new Store,this.bus=new eventBus,this.animation=new Animation(this.bus),this.x=i,this.y=n,this.w=o,this.h=e,this.bus.add("addAnimation",this,this.addAnimationFrag),this.bus.add("update",this,this.update),this.animation.start(),Shape.bus=this.bus}var guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=16*Math.random()|0;return("x"==t?i:3&i|8).toString(16)})},util={mix:function(t,i,n){t="prototype"in t?t.prototype:t,i="prototype"in i?i.prototype:i,this.extend(t,i,n)},extend:function(t,i,n){for(var o in i)i.hasOwnProperty(o)&&(n?null!=i[o]:null==t[o])&&(t[o]=i[o]);return t}},Store=function(){this.store=[]};Store.prototype={add:function(t){this.store.push(t)},update:function(){},delete:function(){}};var pOption={x:10,y:10,r:10,sides:7,fillStyle:"red",strokeStyle:"red",rotate:0,rotateOrigin:null},Polygon=function(t){var i=util.extend(t,pOption);this.x=i.x,this.y=i.y,this.x=i.x,this.radius=i.r,this.sides=i.sides,this.rotate=i.rotate,this.rotateOrigin=i.rotateOrigin,this.fillStyle=i.fillStyle,this.strokeStyle=i.strokeStyle,this.Option=i,this.max={maxX:0,maxY:0,minX:0,minY:0},this.points=this.getPoints(),this._isChoosed=!1};Polygon.prototype={getPoints:function(){var t=[],i=this.Option.startAngle||0;this.max={maxX:0,maxY:0,minX:0,minY:0};for(var n=0;n<this.sides;++n)t.push(new Point(this.Option.x+this.Option.radius*Math.sin(i),this.Option.y-this.Option.radius*Math.cos(i))),this.Option.x+this.Option.radius*Math.sin(i)>this.max.maxX&&(this.max.maxX=this.Option.x+this.Option.radius*Math.sin(i)),this.max.minX||(this.max.minX=this.Option.x+this.Option.radius*Math.sin(i)),this.max.minX&&this.Option.x+this.Option.radius*Math.sin(i)<this.max.minX&&(this.max.minX=this.Option.x+this.Option.radius*Math.sin(i)),this.Option.y+this.Option.radius*Math.sin(i)>this.max.maxY&&(this.max.maxY=this.Option.y+this.Option.radius*Math.sin(i)),this.max.minY||(this.max.minY=this.Option.y+this.Option.radius*Math.sin(i)),this.max.minY&&this.Option.y+this.Option.radius*Math.sin(i)<this.max.minY&&(this.max.minY=this.Option.y+this.Option.radius*Math.sin(i)),i+=2*Math.PI/this.Option.sides;return t},createPath:function(t){var i=this.getPoints();t.beginPath(),t.moveTo(i[0].x,i[0].y);for(var n=1;n<this.Option.sides;++n)t.lineTo(i[n].x,i[n].y);t.closePath()},stroke:function(t){t.save(),this.Option.rotateOrigin||t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),this.createPath(t),t.setStrokeStyle(this.Option.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),this.Option.rotateOrigin||t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),this.createPath(t),t.setStrokeStyle(this.Option.fillStyle),t.fill(),t.restore()},move:function(t,i){this.Option.x=t,this.Option.y=i},detected:function(t,i){t>this.max.minX&&t<this.max.maxX&&i>this.max.minY&&i<this.max.maxY&&(this.points=this.getPoints(),this._offsetX=this.Option.x-t,this._offsetY=this.Option.y-i,this._pnpolyTest(t,i)&&(this._isChoosed=!0))},moveDetect:function(t,i){1==this._isChoosed&&this.move(t+this._offsetX,i+this._offsetY)},upDetect:function(){this._isChoosed=!1},_pnpolyTest:function(t,i){for(var n=!1,o=0,e=this.points.length-1;o<this.points.length;e=o++){var s=this.points[o].x,r=this.points[o].y,a=this.points[e].x,h=this.points[e].y;r>i!=h>i&&t<(a-s)*(i-r)/(h-r)+s&&(n=!n)}return console.log(n),n}};var cOption={fillStyle:"red",strokeStyle:"red",x:10,y:10,r:10,sA:0,eA:2*Math.PI,counterclockwise:!1,rotate:0,rotateOrigin:null},rOption={x:10,y:10,w:10,h:10,fillStyle:"red",strokeStyle:"red",rotate:0,rotateOrigin:null},Circle=function(t){var i=util.extend(t,cOption);this.Option=i,this._isChoosed=!1,this._offsetX=0,this._offsetY=0};Circle.prototype={stroke:function(t){t.save(),t.beginPath(),this.Option.rotateOrigin||t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),t.arc(this.Option.x,this.Option.y,this.Option.r,this.Option.sA,this.Option.eA,this.Option.counterclockwise),t.closePath(),t.setStrokeStyle(this.Option.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),t.beginPath(),this.Option.rotateOrigin||t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),t.arc(this.Option.x,this.Option.y,this.Option.r,this.Option.sA,this.Option.eA,this.Option.counterclockwise),t.closePath(),t.setFillStyle(this.Option.fillStyle),t.fill(),t.restore()},move:function(t,i){this.Option.x=t,this.Option.y=i},detected:function(t,i){var n=this;if(Math.pow(n.Option.x-t,2)+Math.pow(n.Option.y-i,2)<=Math.pow(n.Option.r,2))return this._offsetX=n.Option.x-t,this._offsetY=n.Option.y-i,console.log("x",this._offsetX),console.log("y",this._offsetY),this._isChoosed=!0,!0},moveDetect:function(t,i){1==this._isChoosed&&this.move(t+this._offsetX,i+this._offsetY)},upDetect:function(){this._isChoosed=!1},updateOption:function(t){this.Option=util.extend(t,this.Option),this.bus.dispatch("update","no")}};var Rect=function(t){var i=util.extend(t,rOption);console.log(i),this.Option=i,this._isChoosed=!1,this._offsetX=0,this._offsetY=0,this.bus=null};Rect.prototype={stroke:function(t){t.save(),t.beginPath(),this.Option.rotateOrigin||t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),t.rect(this.Option.x,this.Option.y,this.Option.w,this.Option.h),t.closePath(),t.setStrokeStyle(this.Option.strokeStyle),t.stroke(),t.restore()},fill:function(t){t.save(),t.beginPath(),this.Option.rotateOrigin?(t.translate(this.Option.rotateOrigin[0],this.Option.rotateOrigin[1]),t.rotate(this.Option.rotate),t.rect(this.Option.x-this.Option.rotateOrigin[0],this.Option.y-this.Option.rotateOrigin[1],this.Option.w,this.Option.h)):(t.translate(this.Option.x,this.Option.y),t.rotate(this.Option.rotate),t.rect(-this.Option.w/2,-this.Option.h/2,this.Option.w,this.Option.h)),t.closePath(),t.setFillStyle(this.Option.fillStyle),t.fill(),t.translate(0,0),t.restore()},move:function(t,i){this.Option.x=t,this.Option.y=i},detected:function(t,i){var n=this;if(n.Option.x<t&&n.Option.y<i&&n.Option.y+n.Option.h>i&&n.Option.x+n.Option.w>t)return this._offsetX=t-n.Option.x,this._offsetY=i-n.Option.y,console.log("移动方块"),this._isChoosed=!0,!0},moveDetect:function(t,i){1==this._isChoosed&&this.move(t-this._offsetX,i-this._offsetY)},upDetect:function(){this._isChoosed=!1},updateOption:function(t){this.Option=util.extend(t,this.Option),this.bus.dispatch("update","no")}};var EasingFunctions={linear:function(t){return t},easeInQuad:function(t){return Math.pow(t,2)},easeOutQuad:function(t){return-(Math.pow(t-1,2)-1)},easeInOutQuad:function(t){return(t/=.5)<1?.5*Math.pow(t,2):-.5*((t-=2)*t-2)},easeInCubic:function(t){return Math.pow(t,3)},easeOutCubic:function(t){return Math.pow(t-1,3)+1},easeInOutCubic:function(t){return(t/=.5)<1?.5*Math.pow(t,3):.5*(Math.pow(t-2,3)+2)},easeInQuart:function(t){return Math.pow(t,4)},easeOutQuart:function(t){return-(Math.pow(t-1,4)-1)},easeInOutQuart:function(t){return(t/=.5)<1?.5*Math.pow(t,4):-.5*((t-=2)*Math.pow(t,3)-2)},easeInQuint:function(t){return Math.pow(t,5)},easeOutQuint:function(t){return Math.pow(t-1,5)+1},easeInOutQuint:function(t){return(t/=.5)<1?.5*Math.pow(t,5):.5*(Math.pow(t-2,5)+2)},easeInSine:function(t){return 1-Math.cos(t*(Math.PI/2))},easeOutSine:function(t){return Math.sin(t*(Math.PI/2))},easeInOutSine:function(t){return-.5*(Math.cos(Math.PI*t)-1)},easeInExpo:function(t){return 0===t?0:Math.pow(2,10*(t-1))},easeOutExpo:function(t){return 1===t?1:1-Math.pow(2,-10*t)},easeInOutExpo:function(t){return 0===t?0:1===t?1:(t/=.5)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*--t))},easeInCirc:function(t){return-(Math.sqrt(1-t*t)-1)},easeOutCirc:function(t){return Math.sqrt(1-Math.pow(t-1,2))},easeInOutCirc:function(t){return(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},easeOutBounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},easeInBack:function(t){var i=1.70158;return t*t*((i+1)*t-i)},easeOutBack:function(t){var i=1.70158;return(t-=1)*t*((i+1)*t+i)+1},easeInOutBack:function(t){var i=1.70158;return(t/=.5)<1?t*t*((1+(i*=1.525))*t-i)*.5:.5*((t-=2)*t*((1+(i*=1.525))*t+i)+2)},elastic:function(t){return-1*Math.pow(4,-8*t)*Math.sin((6*t-1)*(2*Math.PI)/2)+1},swingFromTo:function(t){var i=1.70158;return(t/=.5)<1?t*t*((1+(i*=1.525))*t-i)*.5:.5*((t-=2)*t*((1+(i*=1.525))*t+i)+2)},swingFrom:function(t){var i=1.70158;return t*t*((i+1)*t-i)},swingTo:function(t){var i=1.70158;return(t-=1)*t*((i+1)*t+i)+1},bounce:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},bouncePast:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?2-(7.5625*(t-=1.5/2.75)*t+.75):t<2.5/2.75?2-(7.5625*(t-=2.25/2.75)*t+.9375):2-(7.5625*(t-=2.625/2.75)*t+.984375)},easeFromTo:function(t){return(t/=.5)<1?.5*Math.pow(t,4):-.5*((t-=2)*Math.pow(t,3)-2)},easeFrom:function(t){return Math.pow(t,4)},easeTo:function(t){return Math.pow(t,.25)}};Watch.prototype={start:function(){this.startTime=+new Date,this.goesBytime=void 0,this.running=!0},stop:function(){this.goesBy=+new Date-this.startTime,this.running=!1},getGoesByTime:function(){if(this.running){var t=+new Date-this.startTime;return t>1&&!isNaN(t)?t:0}return this.goesBy},isRunning:function(){return this.running},reset:function(){this.goesBy=0}};var AnimationTimer=function(t,i){void 0!==t&&(this.duration=t),void 0!==i&&(this.timeFunc=i),this.watch=new Watch};AnimationTimer.prototype={start:function(){this.watch.start()},stop:function(){this.watch.stop()},getGoesByTime:function(){var t=this.watch.getGoesByTime();console.log(t);var i=t/this.duration;if(this.watch.running)return this.timeFunc?t*(EasingFunctions[this.timeFunc](i)/i):t},isOver:function(){return this.watch.getGoesByTime()>this.duration}};var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},asyncGenerator=function(){function t(t){this.value=t}function i(i){function n(t,i){return new Promise(function(n,e){var a={key:t,arg:i,resolve:n,reject:e,next:null};r?r=r.next=a:(s=r=a,o(t,i))})}function o(n,s){try{var r=i[n](s),a=r.value;a instanceof t?Promise.resolve(a.value).then(function(t){o("next",t)},function(t){o("throw",t)}):e(r.done?"return":"normal",r.value)}catch(t){e("throw",t)}}function e(t,i){switch(t){case"return":s.resolve({value:i,done:!0});break;case"throw":s.reject(i);break;default:s.resolve({value:i,done:!1})}s=s.next,s?o(s.key,s.arg):r=null}var s,r;this._invoke=n,"function"!=typeof i.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(i.prototype[Symbol.asyncIterator]=function(){return this}),i.prototype.next=function(t){return this._invoke("next",t)},i.prototype.throw=function(t){return this._invoke("throw",t)},i.prototype.return=function(t){return this._invoke("return",t)},{wrap:function(t){return function(){return new i(t.apply(this,arguments))}},await:function(i){return new t(i)}}}(),toConsumableArray=function(t){if(Array.isArray(t)){for(var i=0,n=Array(t.length);i<t.length;i++)n[i]=t[i];return n}return Array.from(t)},FRAGOPTION={onStart:function(){},onLooping:function(){},onEnd:function(){},duration:1e3,easing:"linear"},AnimationFrag=function(t,i,n,o,e){var s=util.extend(o,FRAGOPTION);this.object=t,this.source=0,this.genFlag=!1,this.bus=e,this.complete=!1,this.running=!1,this.started=!1,this.duration=s.duration,this.atrribute=i,this.atrributeList=[],"object"==(void 0===i?"undefined":_typeof(i))?(this.genFlag=!0,this.genAtrributeList(i)):this.incre=genExe(n,i,t),this.timer=new AnimationTimer(s.duration,s.easing),this.endCallFrag=null,this.onEnd=s.onEnd,this.onLooping=s.onLooping,this.onStart=s.onStart};AnimationFrag.prototype={updateAnimation:function(){return this.complete?(this.endCallFrag?this.endCallFrag.updateAnimation():this.bus.dispatch("animationComplete","no",this.object.Shapeid),!1):this.timer.isOver()?(this.onEnd(),this.complete=!0,this.running=!1,this.endCallFrag&&this.endCallFrag.updateAnimation(),!1):void(this.started||this.complete?(this.onLooping(),this.updateAtrribute()):(this.genFlag||(this.source=this.object.Shape[this.atrribute]),this.started=!0,this.running=!0,this.onStart(),this.timer.start()))},updateAtrribute:function(){this.genFlag?this.atrributeList.forEach(function(t){this.object.Shape[t.attr]=t.source+t.incre*this.timer.getGoesByTime()/this.duration},this):this.object.Shape[this.atrribute]=this.source+this.incre*this.timer.getGoesByTime()/this.duration},genAtrributeList:function(t){var i=Object.keys(t),n=this;i.forEach(function(i){n.atrributeList.push({attr:i,incre:genExe(t[i],i,n.object),source:n.object.Shape[i]})})}};var Shape=function(t,i,n,o,e){this.draggable=!!o,this.highlight=!!e,this.strokeOrfill=!!n,this.type=t,this.Shape=new shapeTypes[t](i),this.AnimationTimer=new AnimationTimer,this.animtionFragList=[],this.bus=null,this.Shapeid="sp"+guid()};Shape.prototype={updateBus:function(t){this.bus=t},paint:function(t){this.strokeOrfill?this.Shape.fill(t):this.Shape.stroke(t)},detect:function(t,i){this.Shape.detected(t,i),this.Shape.detected(t,i)},moveDetect:function(t,i){this.draggable&&this.Shape.moveDetect(t,i)},upDetect:function(){this.Shape.upDetect()},animate:function(t,i,n){console.log("添加形状");var o=null;return o="object"==(void 0===t?"undefined":_typeof(t))?new AnimationFrag(this,t,"no",arguments[1],this.bus):new AnimationFrag(this,t,arguments[1],arguments[2],this.bus),this.bus.dispatch("addAnimation","no",o,this.Shapeid),console.log("继续调用",this),this},updateOption:function(t){return this.Shape.bus||(this.Shape.bus=this.bus),this.Shape.updateOption(t),this}};var shapeTypes={circle:function(t){return new Circle(t)},rect:function(t){return new Rect(t)},polygon:function(t){return new Polygon(t)}},AnimationFrame=function(){return requestAnimationFrame||fakeAnimationFrame},animationFrame=AnimationFrame(),Animation=function(t){this.running=!1,this.paused=!0,this.bus=t,this.animationFragStore={},this.animationCompleteList=[],this.bus.add("animationComplete",this,this.animationComplete)};Animation.prototype={start:function(){this.running=!0,this.loopAnimation()},loopAnimation:function(){function t(){animationFrame(t),i.running&&i.updateStep()}var i=this;animationFrame(t)},updateStep:function(){Object.keys(this.animationFragStore).forEach(function(t){var i=this.animationFragStore[t];i.forEach(function(t,n){t.endCallFrag=i[n+1],0==n&&t.updateAnimation()})},this),this.bus.dispatch("update","no")},animationComplete:function(t){this.animationCompleteList.push(t),this.animationCompleteList.length===Object.keys(this.animationFragStore).length&&(this.running=!1,console.log("结束动画"))}};var eventBus=function(){this.eventList=[]};eventBus.prototype={add:function(t,i,n){console.log("添加"+t),this.eventList.length?(this.eventList.forEach(function(i){if(i.name==t)return i.thingsList.push(n),!1},this),this.eventList.push({name:t,scope:i,thingsList:[n]})):this.eventList.push({name:t,scope:i,thingsList:[n]}),console.log(this.eventList)},dispatch:function(t,i){var n=arguments;if(arguments.length<2)return!1;var o=Array.prototype.slice.call(n,1);this.eventList.forEach(function(n){n.name===t&&(console.log("触发"+t),n.thingsList.forEach(function(t){"no"!==i?t.call.apply(t,[i].concat(toConsumableArray(o))):t.call.apply(t,[n.scope].concat(toConsumableArray(o)))}))})},destroy:function(){}},WxDraw.prototype={add:function(t){t.updateBus(this.bus),this.store.add(t)},draw:function(){this.store.store.forEach(function(t){t.paint(this.canvas)},this)},detect:function(t){var i=this.getLoc(t.touches[0].x,t.touches[0].y);this.store.store.forEach(function(t){t.detect(i.x,i.y)},this)},moveDetect:function(t){var i=this.getLoc(t.touches[0].x,t.touches[0].y);this.store.store.forEach(function(t){t.moveDetect(i.x,i.y)},this),this.draw(),this.canvas.draw()},upDetect:function(){this.store.store.forEach(function(t){t.upDetect()},this)},getLoc:function(t,i){return{x:t-this.x>0?t-this.x>this.w?this.w:t-this.x:this.x,y:i-this.y>0?i-this.y>this.h?this.h:i-this.y:this.y}},update:function(){this.draw(),this.canvas.draw()},AnimationCenter:function(){},addAnimationFrag:function(t,i,n){console.log(i),this.animation.animationFragStore[n]?(console.log("已经有动画了"),this.animation.animationFragStore[n].push(i)):(console.log("初始化 "),this.animation.animationFragStore[n]=[i]),console.log(this.animation.animationFragStore2)}},module.exports={WxDraw:WxDraw,Shape:Shape,AnimationFrame:AnimationFrame()};
